// pipeline {
//     agent any

//     environment {
//         TF_VERSION = "1.6.6"
//         TF_DIR = "envs/shared"
//     }

//     stages {
//         stage('Setup Terraform') {
//             steps {
//                 script {
//                     sh '''
//                         if ! command -v terraform >/dev/null 2>&1; then
//                             echo "Installing Terraform..."
//                             sudo apt-get update -y
//                             sudo apt-get install -y unzip wget
//                             wget https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
//                             unzip terraform_${TF_VERSION}_linux_amd64.zip
//                             sudo mv terraform /usr/local/bin/
//                             terraform -v
//                         else
//                             echo "Terraform already installed."
//                             terraform -v
//                         fi
//                     '''
//                 }
//             }
//         }

//         stage('Checkout Code') {
//             steps {
//                 git branch: 'main', url: 'https://github.com/Devops8989/infra-terraform.git'
//             }
//         }

//         stage('Verify IAM Role Access') {
//             steps {
//                 sh '''
//                     echo "Verifying IAM Role attached to Jenkins EC2..."
//                     aws sts get-caller-identity
//                 '''
//             }
//         }

//         stage('Terraform Init') {
//             steps {
//                 dir("${TF_DIR}") {
//                     sh '''
//                         unset AWS_PROFILE
//                         echo "Initializing Terraform in shared environment..."
//                         terraform init -reconfigure -input=false
//                     '''
//                 }
//             }
//         }

//         stage('Terraform Validate') {
//             steps {
//                 dir("${TF_DIR}") {
//                     sh '''
//                         unset AWS_PROFILE
//                         echo "Validating Terraform configuration..."
//                         terraform validate
//                     '''
//                 }
//             }
//         }

//         stage('Terraform Plan') {
//             steps {
//                 dir("${TF_DIR}") {
//                     sh '''
//                         unset AWS_PROFILE
//                         echo "Running Terraform plan for shared environment..."
//                         terraform plan -input=false
//                     '''
//                 }
//             }
//         }
//     }

//     post {
//         success {
//             echo "✅ Terraform Init/Plan for shared environment completed successfully."
//         }
//         failure {
//             echo "❌ Terraform pipeline for shared environment failed. Check logs."
//         }
//     }
// }

pipeline {
    agent any

    environment {
        TF_VERSION = "1.6.6"
        TF_DIR     = "envs/shared"
        AWS_REGION = "us-east-1"
        BACKEND_ROLE_ARN = "arn:aws:iam::583534901542:role/terraform-backend-access-role"
    }

    stages {

        stage('Install Dependencies') {
            steps {
                sh '''
                    sudo apt-get update -y

                    # Install AWS CLI if missing
                    if ! command -v aws >/dev/null 2>&1; then
                        echo "Installing AWS CLI..."
                        sudo apt-get install -y unzip curl
                        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                        unzip awscliv2.zip
                        sudo ./aws/install
                    fi

                    # Install JQ
                    if ! command -v jq >/dev/null 2>&1; then
                        echo "Installing jq..."
                        sudo apt-get install -y jq
                    fi

                    # Install Terraform if missing
                    if ! command -v terraform >/dev/null 2>&1; then
                        echo "Installing Terraform..."
                        sudo apt-get install -y unzip wget
                        wget https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip
                        unzip terraform_${TF_VERSION}_linux_amd64.zip
                        sudo mv terraform /usr/local/bin/
                    fi

                    terraform -version
                    aws --version
                    jq --version
                '''
            }
        }

        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/Devops8989/infra-terraform.git'
            }
        }

        stage('Verify IAM Role Access') {
            steps {
                sh '''
                    echo "Current IAM Identity of Jenkins EC2:"
                    aws sts get-caller-identity
                '''
            }
        }

        stage('Assume Shared Backend Role') {
            steps {
                script {
                    sh '''
                        echo "Assuming Role: ${BACKEND_ROLE_ARN}"

                        CREDS=$(aws sts assume-role \
                            --role-arn ${BACKEND_ROLE_ARN} \
                            --role-session-name jenkinsBackend \
                            --query "Credentials" --output json)

                        export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r '.AccessKeyId')
                        export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r '.SecretAccessKey')
                        export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r '.SessionToken')

                        echo "Assumed role successfully:"
                        aws sts get-caller-identity
                    '''
                }
            }
        }

        stage('Terraform Init') {
            steps {
                dir("${TF_DIR}") {
                    sh '''
                        echo "Initializing Terraform with Shared Account Backend..."
                        terraform init -reconfigure -input=false
                    '''
                }
            }
        }

        stage('Terraform Validate') {
            steps {
                dir("${TF_DIR}") {
                    sh '''
                        terraform validate
                    '''
                }
            }
        }

        stage('Terraform Plan') {
            steps {
                dir("${TF_DIR}") {
                    sh '''
                        terraform plan -input=false
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "✅ Terraform Init/Validate/Plan completed successfully for shared environment."
        }
        failure {
            echo "❌ Terraform pipeline failed. Check logs."
        }
    }
}
