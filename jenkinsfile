// pipeline {
//     agent any

//     environment {
//         TF_VERSION = "1.6.6"
//         TF_DIR     = "envs/shared"
//         AWS_REGION = "us-east-1"
//     }

//     stages {

//         stage("Checkout Code") {
//             steps {
//                 git branch: 'main', url: 'https://github.com/Devops8989/infra-terraform.git'
//             }
//         }

//         stage("Verify EC2 IAM Role") {
//             steps {
//                 sh '''
//                     echo "========== AWS Identity (EC2 IAM Role) =========="
//                     aws sts get-caller-identity
//                     echo "================================================="
//                 '''
//             }
//         }

//         stage("Terraform Init (Cross-Account Backend)") {
//             steps {
//                 dir("${TF_DIR}") {
//                     sh '''
//                         echo "Running Terraform Init..."
//                         terraform init -reconfigure -input=false
//                     '''
//                 }
//             }
//         }

//         stage("Terraform Validate") {
//             steps {
//                 dir("${TF_DIR}") {
//                     sh '''
//                         terraform validate
//                     '''
//                 }
//             }
//         }

//         stage("Terraform Plan") {
//             steps {
//                 dir("${TF_DIR}") {
//                     sh '''
//                         terraform plan -input=false
//                     '''
//                 }
//             }
//         }
//     }

//     post {
//         success {
//             echo "Terraform Plan executed successfully!"
//         }
//         failure {
//             echo "Pipeline Failed — fix the errors."
//         }
//     }
// }

// pipeline {
//     agent any

//     environment {
//         TF_VERSION = "1.6.6"
//         SHARED_DIR = "envs/shared"
//         STAGING_DIR = "envs/staging"
//         AWS_REGION = "us-east-1"
//     }

//     stages {

//         stage("Checkout Code") {
//             steps {
//                 git branch: 'main', url: 'https://github.com/Devops8989/infra-terraform.git'
//             }
//         }

//         stage("Verify IAM Role on EC2") {
//             steps {
//                 sh '''
//                     echo "========== AWS Identity (EC2 IAM Role) =========="
//                     aws sts get-caller-identity
//                     echo "================================================="
//                 '''
//             }
//         }

//         /* ----------------------------------------------------
//            SHARED ACCOUNT (REMOTE BACKEND) - PLAN ONLY
//         ---------------------------------------------------- */
//         stage("Terraform Init (Shared)") {
//             steps {
//                 dir("${SHARED_DIR}") {
//                     sh '''
//                         echo "Running Terraform Init for SHARED..."
//                         terraform init -reconfigure -input=false
//                     '''
//                 }
//             }
//         }

//         stage("Terraform Plan (Shared)") {
//             steps {
//                 dir("${SHARED_DIR}") {
//                     sh '''
//                         echo "Running Shared Terraform Plan..."
//                         terraform plan -input=false
//                     '''
//                 }
//             }
//         }

//         /* ----------------------------------------------------
//            STAGING ENVIRONMENT (ASSUME ROLE)
//         ---------------------------------------------------- */
//         stage("Terraform Init (Staging)") {
//             steps {
//                 dir("${STAGING_DIR}") {
//                     sh '''
//                         echo "Running Terraform Init for STAGING..."
//                         terraform init -reconfigure -input=false
//                     '''
//                 }
//             }
//         }

//         stage("Terraform Plan (Staging)") {
//             steps {
//                 dir("${STAGING_DIR}") {
//                     sh '''
//                         echo "Running Terraform Plan for STAGING..."
//                         terraform plan -input=false
//                     '''
//                 }
//             }
//         }
//     }

//     post {
//         success {
//             echo "Shared + Staging Terraform Plan finished successfully!"
//         }
//         failure {
//             echo "Pipeline Failed — fix errors."
//         }
//     }
// }
pipeline {
    agent any

    environment {
        TF_VERSION = "1.6.6"
        AWS_REGION = "us-east-1"
    }

    stages {

        stage("Checkout Code") {
            steps {
                checkout scm
            }
        }

        stage("Verify IAM Role on EC2") {
            steps {
                sh '''
                    echo "========== AWS Identity (EC2 IAM Role) =========="
                    aws sts get-caller-identity
                    echo "================================================="
                '''
            }
        }

        stage("Terraform Init") {
            steps {
                script {
                    if (env.BRANCH_NAME == "feature" || env.BRANCH_NAME.startsWith("feature/")) {
                        env.TF_DIR = "envs/shared"
                    } 
                    else if (env.BRANCH_NAME == "staging") {
                        env.TF_DIR = "envs/staging"
                    } 
                    else {
                        error("Unsupported branch. Use feature/* or staging.")
                    }
                }

                dir("${TF_DIR}") {
                    sh '''
                        terraform init -reconfigure -input=false
                    '''
                }
            }
        }

        stage("Terraform Validate") {
            steps {
                dir("${TF_DIR}") {
                    sh "terraform validate"
                }
            }
        }

        stage("Terraform Plan") {
            steps {
                dir("${TF_DIR}") {
                    sh "terraform plan -input=false"
                }
            }
        }

        stage("Terraform Apply (ONLY for staging branch)") {
            when {
                branch "staging"
            }
            steps {
                dir("${TF_DIR}") {
                    sh "terraform apply -auto-approve -input=false"
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline Completed Successfully!"
        }
        failure {
            echo "Pipeline Failed — Fix issues."
        }
    }
}
